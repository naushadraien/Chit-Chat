name: Android App APK Build

on:
  push:
    branches:
      - main
    paths:
      - "client/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    steps:
      - name: Setup repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_ACCESS_TOKEN }}

      - name: Install dependencies
        run: bun install

      - name: Configure EAS project
        run: |
          # Add owner to app.json if needed
          if [ -f "app.json" ]; then
            if ! grep -q "owner" app.json; then
              jq '.expo.owner = "naushadraien"' app.json > app.json.tmp && mv app.json.tmp app.json
              echo "Added owner to app.json"
            fi
          else
            echo "app.json not found, running eas init"
            echo "y" | bunx eas init --non-interactive
          fi

      - name: Configure eas.json for local build
        run: |
          cat > eas.json << EOF
          {
            "cli": {
              "version": ">= 3.13.3",
              "appVersionSource": "remote"
            },
            "build": {
              "preview": {
                "distribution": "internal",
                "android": {
                  "buildType": "apk",
                  "withoutCredentials": true
                }
              }
            }
          }
          EOF
          echo "Created eas.json for local build"
          cat eas.json

      - name: Set up environment variables
        run: |
          # Create .env file with correct backend URL based on branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Production URL (from GitHub secret)
            echo "EXPO_PUBLIC_BACKEND_URL=${{ secrets.EXPO_PUBLIC_BACKEND_URL_PROD }}" > .env
            echo "Using production backend URL"
          else
            # Development/staging URL
            echo "EXPO_PUBLIC_BACKEND_URL=${{ secrets.EXPO_PUBLIC_BACKEND_URL_DEV || 'http://localhost:3001' }}" > .env
            echo "Using development backend URL"
          fi

          # Show the configured URL (but mask the actual value for security)
          echo "Backend URL configured with prefix: $(echo $EXPO_PUBLIC_BACKEND_URL | cut -c 1-10)..."

      - name: Build Android app
        run: bunx eas build --platform android --profile preview --local --output ./ChitChat.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChitChat-APK
          path: ./client/ChitChat.apk
          retention-days: 14
