name: Build & Download Expo APK

on:
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install Dependencies
        run: bun install

      - name: ğŸš€ Install EAS CLI
        run: bun add -g eas-cli

      - name: ğŸ” Login to Expo
        run: eas login --access-token ${{ secrets.EXPO_ACCESS_TOKEN }}

      - name: ğŸ— Start APK Build
        run: eas build --platform android --non-interactive --profile android --json > build-result.json

      - name: â³ Wait for Build & Get APK URL
        id: wait_and_get_url
        run: |
          BUILD_ID=$(jq -r '.builds.android.buildId' build-result.json)
          echo "Build ID: $BUILD_ID"

          STATUS=""
          until [[ "$STATUS" == "finished" || "$STATUS" == "errored" ]]; do
            STATUS=$(eas build:status --json | jq -r '.builds[0].status')
            echo "Status: $STATUS"
            sleep 15
          done

          if [ "$STATUS" == "finished" ]; then
            APK_URL=$(eas build:status --json | jq -r '.builds[0].artifacts.buildUrl')
            echo "âœ… APK URL: $APK_URL"
            echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
          else
            echo "âŒ Build failed"
            exit 1
          fi

      - name: ğŸ“¥ Download APK
        run: |
          curl -L "${{ steps.wait_and_get_url.outputs.apk_url }}" -o app.apk

      - name: ğŸ“¤ Upload APK as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: expo-apk
          path: app.apk
